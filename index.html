<!DOCTYPE html>
<html>
<head>
    <title>XMRE - Deals, Loans, Properties</title>
    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/util.js"></script>
    <link rel="stylesheet" href="css/style.css" type="text/css">
    <style>

    </style>
</head>
<body>
    <div id="container">
        <div id="social_graph"></div>
    </div>

<script>
$( document ).ready(function() {
    
    /********************************************
     * SVG and containers
     ********************************************/    
    var windowwidth = $( window ).width(); // window width
    var sgraphHeight = 450;    
    
    var margin = {top: 5, right: 0, bottom: 5, left: 0},
        width = windowwidth - margin.left - margin.right - 15,
        height = sgraphHeight - margin.top - margin.bottom;
        
    var duration = 500;
    
    var zoom = d3.behavior.zoom()
        .scaleExtent([1, 10])
        .on("zoom", zoomed);

    var svg = d3.select("#social_graph").append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .append("g")
        .attr("viewBox", "0 0 " + width + " " + height )
        .attr("overflow", "hidden")
        .attr("transform", "translate(" + margin.left + "," + margin.right + ")")
        .attr("class", "svg_cont")       
        .call(zoom)
        .on("dblclick.zoom", null);

    var rect = svg.append("rect")
        .attr("width", width)
        .attr("height", height)
        .style("fill", "none")
        .style("pointer-events", "all");

    var container = svg.append("g");

    var tooltip = d3.select("body").append("div")   
        .attr("class", "social-graph-tooltip")               
        .style("opacity", 0);
   
    /********************************************
     * All the graph methods and configs
     ********************************************/    
           // deals
    function deals(){}    
    // initial configs
    // deals graph start position
    deals.prototype.dealsStart = windowwidth / 100 * 80 ; // start after 80 % 
    deals.prototype.drootr = 40;
    deals.prototype.dlevel1r = 30;
    deals.prototype.dnodedepth = 100;
    
    deals.prototype.di = 0;    
    deals.prototype.maxDisplayChar = 10;
    deals.prototype.droot = '';
    
    deals.prototype.dviewerWidth = 800;
    deals.prototype.dviewerHeight = 450;

    var dealsObj = new deals();
    
    // for responsive
    if(dealsObj.dealsStart < 1000){
        dealsObj.drootr = 30;
        dealsObj.dlevel1r = 25;
        dealsObj.dnodedepth = 80;
    }

    // loans
    function loans(){}
    // loans graph start position
    loans.prototype.loansStart = windowwidth / 100 * 55 ; // start after 40 %
    loans.prototype.lrootr = 40;
    loans.prototype.llevel1r = 35;
    loans.prototype.llevel2r = 30;
    loans.prototype.lnodedepth = 100;
    loans.prototype.lnodesizex = 80;
    loans.prototype.lnodesizey = 80;    
    
    loans.prototype.li = 0;    
    loans.prototype.maxDisplayChar = 10;
    loans.prototype.lroot = '';    
    loans.prototype.lheight = 430;      
  

    var loansObj = new loans();
        // for responsive
    if(loansObj.loansStart < 650){
        loansObj.lrootr = 30;
        loansObj.llevel1r = 25;
        loansObj.llevel2r = 20;        
        loansObj.lnodesizex = 60;
        loansObj.lnodesizey = 30;
        loansObj.lnodedepth = 80;
    }    
    
    // properties
    function properties(){};    
    // properties graph start position
    properties.prototype.propertiesStart = windowwidth / 100 * 20 ; // start after 20 %
    properties.prototype.prootr = 40;
    properties.prototype.plevel1r = 35;
    properties.prototype.plevel2r = 25;
    properties.prototype.pnodedepth = 90;
    properties.prototype.pheight = 800; 
    
    properties.prototype.pi = 0;    
    properties.prototype.maxDisplayChar = 10;
    properties.prototype.proot = ''; 
    
    properties.prototype.ptreeAngle = 360; 

    var propertiesObj = new properties();
        // for responsive
    if(propertiesObj.propertiesStart < 200){
        propertiesObj.prootr = 30;
        propertiesObj.plevel1r = 25;
        propertiesObj.plevel2r = 20;
        propertiesObj.pnodedepth = 70;
    }    
    
    /********************************************
     * Draw the lines between loan to deal and loan to property
     ********************************************/

    // Draw straight lines between loans and properties    
    var loansToPropertiesLine = container.append("g:line")
        .attr("x1", propertiesObj.propertiesStart + propertiesObj.prootr)
        .attr("y1", 225)
        .attr("x2", loansObj.loansStart - loansObj.lrootr)
        .attr("y2", 225)
        .attr("class", "loansToProperties"); 
    // Draw straight lines between deals and loans
    var dealsToLoansLine = container.append("g:line")
        .attr("x1", loansObj.loansStart + loansObj.lrootr)
        .attr("y1", 225)
        .attr("x2", dealsObj.dealsStart - dealsObj.drootr)
        .attr("y2", 225)
        .attr("class", "dealsToLoans");


    /**********************************************
     * Deals D3 js svg containers
     **********************************************/   
             
    var dtree = d3.layout.tree()
       .size([dealsObj.dviewerHeight, dealsObj.dviewerWidth]);

    // define a d3 diagonal projection for use by the node paths later on.
    var ddiagonal = d3.svg.diagonal()
        .projection(function(d) {
            return [d.y, d.x];
        });

    var dealsGroup = container.append("g")
                              .attr("transform", "translate("+ dealsObj.dealsStart + ",0)"); 
                      
    /**********************************************
     * Loans D3 js svg containers
     **********************************************/   
    var ltree = d3.layout.tree()
        .nodeSize([loansObj.lnodesizex, loansObj.lnodesizey]);

    var ldiagonal = d3.svg.diagonal()
            .projection(function(d) { return [d.x, d.y]; });
    
    var loansGroup = container.append("g")
                              .attr("transform", "translate("+ loansObj.loansStart +",225)"); 
    /**********************************************
     * Properties D3 js svg containers
     **********************************************/                        
    var pdiagonal = d3.svg.diagonal.radial()
        .projection(function(d) { return [d.y, d.x / 180 * Math.PI]; }); 

    var propertiesGroup = container.append("g")
        .attr("transform", "translate("+ propertiesObj.propertiesStart +",225)"); 

    /********************************************
     * All the data and backend values
     ********************************************/  
    var dealData = {};
    var loanData = {};
    var propertiesData = {};
    
    var selectedloan='';
    var relatedDealId='';
    
    var dealId = Util.getUrlParamByName('did');
    var loanId = Util.getUrlParamByName('lid');
    var propertyId = Util.getUrlParamByName('pid');
    
    //var dealId = '@ViewBag.DealID';
    
    /*************************
     * Get the id
     *************************/
    if(dealId && dealId!=''){
        // got deal id
         getDataAndRenderDeal('deal', dealId);
         getDataAndRenderLoanAndCallOthers('loandeal', dealId, true, false); // render proprty true, render deal false

    }else if(loanId && loanId!=''){
        // deal id is empty and loan id is present --first render loan then deal
        // 65648
        var entity = 'loan';
        getDataAndRenderLoanAndCallOthers(entity, loanId, true, true); // render proprty true, render deal true
        
    }else if(propertyId && propertyId!=''){
        getPropertyAndRender('property', propertyId, true, true);
        
    }else{
        renderEmptyDeal();
        renderEmptyLoan();
        renderEmptyProperty();
    }
    
    function renderEmptyDeal(){
                // just render simple circle
        dealData.currencySymbol = "&pound;";
        dealData.colorDefault = "dwhite";
        dealData.colorSelected = "dwhite";            
        dealData.sel = true;
        dealData.name ="No Deal";
        dealData.amount = "";

        renderDeal();
    }
    
    function renderEmptyLoan(){
        //loan
        loanData.currencySymbol = "";
        loanData.colorDefault = "lwhite";
        loanData.colorSelected = "lwhite";
        loanData.sel = true;
        loanData.name = "No Loans";
        loanData.amount = "";        
        renderLoan();        
    }
    
    function renderEmptyProperty(){
        if(propertiesData.children){
            propertiesData.children = '';
        }
        propertiesData.currencySymbol = "&pound;";
        propertiesData.colorDefault = "lwhite";
        propertiesData.colorSelected = "lwhite";
        propertiesData.name = "No Properties";
        propertiesData.amount = "";   

        renderProperties();     
    }    
    
    function getDataAndRenderLoanAndCallOthers(entity, id, prender, drender){
        // first render loan then deal
        d3.json("http://xm2.cloudapp.net:8082/api/SocialGraph/GetData?entityType="+entity+"&id="+id, function(error, serverData) {

            if(serverData == "" || serverData == null || $.isEmptyObject(serverData)){
                renderEmptyLoan();
                
                if(prender){
                    renderEmptyProperty();
                }
                if(drender){
                    renderEmptyDeal();
                }
               
            }else{
                loanData.currencySymbol = "";
                loanData.colorDefault = "loansDefault";
                loanData.colorSelected = "loansSelected";
                loanData.sel = true;
                loanData.name = "loans";
                loanData.amount = "";
                loanData.children = serverData;

                if(loanData.children && loanData.children.length > 8){ // only show 6 tranches now - it can be change
                    loanData.children = loanData.children.slice(0, 8);
                }
                if(loanData.children && loanData.children.length >= 1){
                    loanData.count = loanData.children.length;                
                    $.each( loanData.children, function( key, childObj ) {
                        childObj.currencySymbol = "&pound;";
                        childObj.colorDefault = "b-loansDefault";
                        childObj.colorSelected = "b-loansSelected";
                        childObj.sel = false;
                       
                        // check sub loans
                        /*if(childObj.children){
                         //   childObj.children = subloans(childObj.children);
                        }*/
                    });
                    selectedloan = loanData.children[0].id;
                    loanData.children[0].sel = true;
                    if(drender){
                        relatedDealId = loanData.children[0].parentId;                        
                    }
                }
                
                // show property
                if(prender){
                    if(selectedloan && selectedloan!==''){
                        getPropertyAndRender('propertyloan', selectedloan, false, false);
                        //getPropertyAndRender(66221);
                    }else{
                        getPropertyAndRender('', '', false, false);
                    } 
                }
                // show deals
                if(drender){
                    if(relatedDealId && relatedDealId!==''){
                        getDataAndRenderDeal('deal', relatedDealId);

                    }else{
                       renderEmptyDeal();
                    } 
                }                  
                renderLoan();
            }
        }); 
    }
    
    function getDataAndRenderDeal(entity, id){
        d3.json("http://xm2.cloudapp.net:8082/api/SocialGraph/GetData?entityType="+entity+"&id="+id, function(error, serverData) {
            if(serverData && serverData!==''){
                dealData = serverData[0];
                // adjust the data
                dealData.currencySymbol = "&pound;";
                dealData.colorDefault = "dealsDefault";
                dealData.colorSelected = "dealsSelected";
                dealData.sel = true;

                if(dealData.children.length > 6){ // only show 6 tranches now - it can be change
                    dealData.children = dealData.children.slice(0, 6);
                }

                $.each( dealData.children, function( key, childObj ) {
                    childObj.currencySymbol = "&pound;";
                    childObj.colorDefault = "tranchesDefault";
                    childObj.colorSelected = "tranchesSelected";
                    childObj.sel = false;
                });
            }else{
                // if deal data is empty then render just simple circle
                dealData.currencySymbol = "&pound;";
                dealData.colorDefault = "dwhite";
                dealData.colorSelected = "dwhite";            
                dealData.sel = true;
                dealData.name ="No Deal";
                dealData.amount = "";
            }

           renderDeal();
        });
    }
    
    function subloans(obj){
        $.each( obj, function( key, cObj ) {
            cObj.currencySymbol = "&pound;";
            cObj.colorDefault = "b-loansDefault";
            cObj.colorSelected = "b-loansSelected";
            cObj.sel = false;
            if(cObj.children){
                cObj.children = subloans(cObj.children);
            }
        });
        
        return obj;
    }
    
    function getPropertyAndRender(entity, sloanid, lrender, drender){
        if(sloanid!='' && $.isNumeric(sloanid)){
            // get the data
            d3.json("http://xm2.cloudapp.net:8082/api/SocialGraph/GetData?entityType="+entity+"&id="+sloanid, function(error, serverData) {
                
                if(serverData == "" || serverData == null || $.isEmptyObject(serverData)){
                    renderEmptyProperty();
                        
                    if(lrender){
                       renderEmptyLoan();
                    }
                    if(drender){
                        renderEmptyDeal();
                    }

                }else{
                    // adjust the data
                    propertiesData.currencySymbol = "&pound;";
                    propertiesData.colorDefault = "propertiesDefault";
                    propertiesData.colorSelected = "propertiesSelected";
                    propertiesData.name = "Properties";
                    propertiesData.amount = "";
                    propertiesData.sel = true;
                    
                    propertiesData.children = serverData;
                    
                    if(propertiesData.children && propertiesData.children.length >6){ // only show 6 tranches now - it can be change
                        propertiesData.children = propertiesData.children.slice(0, 6);
                    }
                
                    if(propertiesData.children && propertiesData.children.length >= 1){
                        propertiesData.count = propertiesData.children.length;
                        
                        $.each( propertiesData.children, function( key, childObj ) {
                            childObj.currencySymbol = "&pound;";
                            childObj.colorDefault = "properties-singleDefault";
                            childObj.colorSelected = "properties-singleSelected";
                            childObj.sel = false;

                            // check sub loans
    //                        if(childObj.children){
    //                            childObj.children = subloans(childObj.children);
    //                        }
                        });
                        
                        // show loans
                        if(lrender){
                            relatedLoanId = propertiesData.children[0].parentId;
                            if(relatedLoanId && relatedLoanId!==''){
                                getDataAndRenderLoanAndCallOthers('loan', relatedLoanId, false, drender);
                            }else{
                                renderEmptyLoan();
                                if(drender){
                                   renderEmptyDeal(); 
                                }
                            } 
                        }
                    }
                    
                    renderProperties();                    
                }
            });                  
            
        }else{
            if(propertiesData.children){
                        propertiesData.children = '';
                    }
            propertiesData.currencySymbol = "&pound;";
            propertiesData.colorDefault = "lwhite";
            propertiesData.colorSelected = "lwhite";

            propertiesData.name = "No Properties";
            propertiesData.amount = "";   
            
            renderProperties();
        }

    }
	
    /*********************************
     * Common functions and variables - Helper functions for collapsing and expanding nodes.
     *********************************/

    function collapse(d) {
        if (d.children) {
            d._children = d.children;
            d._children.forEach(collapse);
            d.children = null;
        }
    }

    function expand(d) {
        if (d._children) {
            d.children = d._children;
            d.children.forEach(expand);
            d._children = null;
        }
    }   
    // Toggle children function
    function toggleChildren(d, rootToggle) {
        
        // rootToggle is false always show root node with one level
        if(!rootToggle && !d.parent){
            return d;            
        }        
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else if (d._children) {
            d.children = d._children;
            d._children = null;
        }
        return d;
    }
    
    /**********************************************
     * Deals D3 js 
     **********************************************/   

    function dealsClick(d) {
        if (d3.event.defaultPrevented) return; // click suppressed
        
        if(d.depth!=0){
            d.sel = true;
            if(d.depth > 1 && d.parent){
                d.parent.sel = true
            }
        }
        
        d = toggleChildren(d, true);
        dealsUpdate(d);
        
        if(d.depth!=0){
            d.sel = false;           
            if(d.depth > 1 && d.parent){
                d.parent.sel = false;
            }
        }        
    }

    function dealsUpdate(source) {
        dtree = dtree.size([dealsObj.dviewerHeight, dealsObj.dviewerWidth]);
        // Compute the new tree layout.
        var nodes = dtree.nodes(dealsObj.droot).reverse(),
            links = dtree.links(nodes);

        // Set widths between levels based on node depth
        nodes.forEach(function(d) {
            d.y = (d.depth * dealsObj.dnodedepth); 
        });

        // Update the nodes…
        var node = dealsGroup.selectAll("g.node")
            .data(nodes, function(d) {
                return d.id || (d.id = ++dealsObj.di);
            });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) {
                return "translate(" + source.y0 + "," + source.x0 + ")";
            })
            .on("mouseover", function(d) { if(d.name=='') {return false;}
                tooltip.transition()        
                        .duration(200)
                        .style("opacity", .9);      
                tooltip.html(d.name + "<br/>" + "  ")
                        .style("left", (d3.event.pageX) + "px")
                        .style("width", "150px") 
                        .style("top", (d3.event.pageY - 45) + "px");
            })                  
            .on("mouseout", function(d) {    if(d.name=='') {return false;}   
                tooltip.transition()        
                        .duration(500)
                        .style("opacity", 0);   
            })            
            .on('click', dealsClick);

        nodeEnter.append("svg:circle")
            .attr("r", 1e-6)
            .attr("y", "50");

        var textspan = nodeEnter.append("text")
                .attr("dy", ".20em")
                .attr("text-anchor", "middle");
        
         var tspan1 = textspan.append('tspan');
         var tspan2 = textspan.append('tspan');
         
         tspan1.text(function(d) { return Util.getLimitedChar(d.name, dealsObj.maxDisplayChar); })
               .attr("dy", function(d) { return (d.amount ==='') ? "" : ".07em"; });
         tspan2.html(function(d) { 
                    if(d.amount){var tex = d.currencySymbol +  d.amount; return tex ;}
                        return '';
                    })
                .attr("x", "0")
                .attr("dy", "15");


        // Transition nodes to their new position.
        var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function(d) {
                return "translate(" + d.y + "," + d.x + ")";
            });
            
        nodeUpdate.select("circle")
            .attr("r",   function(d) {
                var rval = 30;
                switch(d.depth){
                    case 0:
                        rval = dealsObj.drootr;
                        break;
                    default:                        
                        rval = dealsObj.dlevel1r;
                }
                return rval;
            })
            .attr("class", function(d) {
                            return d.sel ? d.colorSelected : d.colorDefault; 
            });

        // Fade the text in
        nodeUpdate.select("text")
            .style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function(d) {
                return "translate(" + d.y + "," + d.x + ")";
            })
            .remove();

        nodeExit.select("circle")
            .attr("r", 1e-6);

        nodeExit.select("text")
            .style("fill-opacity", 1e-6);

        // Update the links…
        var link = dealsGroup.selectAll("path.link")
            .data(links, function(d) {
                return d.target.id;
            });

        // Enter any new links at the parent's previous position.
        link.enter().insert("path", "g")
            .attr("class", "link")
            .attr("d", function(d) {
                var o = {
                    x: source.x0,
                    y: source.y0
                };
                return ddiagonal({
                    source: o,
                    target: o
                });
            });

        // Transition links to their new position.
        link.transition()
            .duration(duration)
            .attr("d", ddiagonal);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
            .duration(duration)
            .attr("d", function(d) {
                var o = {
                    x: source.x,
                    y: source.y
                };
                return ddiagonal({
                    source: o,
                    target: o
                });
            })
            .remove();

        // Stash the old positions for transition.
        nodes.forEach(function(d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    function renderDeal(){
        if(dealData && dealData!=''){
            //if data present 
            dealsObj.data = dealData;
                // Define the root
            dealsObj.droot = dealsObj.data;
            dealsObj.droot.x0 = dealsObj.dviewerHeight / 2;
            dealsObj.droot.y0 = 0;

            // only show first level nodes
            if(dealsObj.droot.children && dealsObj.droot.children.length >= 1){
                dealsObj.droot.children.forEach(collapse);
            }
            
            dealsUpdate(dealsObj.droot);
        }
    }

    // deals over
    /**********************************************
     * Loans D3 js
     **********************************************/
   
    function renderLoan(){
        if(loanData && loanData!=''){
            loansObj.data = loanData;
            loansObj.lroot = loansObj.data;
            loansObj.lroot.x0 = loansObj.lheight / 2;
            loansObj.lroot.y0 = 0;
            // display only first level
            if(loansObj.lroot.children && loansObj.lroot.children.length >= 1){
                loansObj.lroot.children.forEach(collapse); 
                loansObj.lroot.children[0].sel = true;
            }
            
            loansUpdate(loansObj.lroot); 

            // after the svg update, reset it 
            if(loansObj.lroot.children && loansObj.lroot.children.length >= 1){
                loansObj.lroot.children[0].sel = false;
            }            
        }
    }
    
    function loansUpdate(source) {
        // Compute the new tree layout.
        var nodes = ltree.nodes(loansObj.lroot).reverse();
        var links = ltree.links(nodes);

        // Normalize for fixed-depth. - parent to child
        nodes.forEach(function(d) { d.y = d.depth * loansObj.lnodedepth; });

        // Update the nodes…
        var node = loansGroup.selectAll("g.node")
            .data(nodes, function(d) { return d.id || (d.id = ++loansObj.li); });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("svg:g")
            .attr("class", "node")
            .attr("transform", function(d) { return "translate(" + d.x + "," + (d.y + 10) + ")"; })
            .on("mouseover", function(d) {if(d.name==''){return false;}
                tooltip.transition()        
                        .duration(200)
                        .style("opacity", .9);      
                tooltip.html(d.name + "<br/>"  + ( (d.amount)? (' ( '+ d.currencySymbol +  d.amount +' )') :"") )
                        .style("left", (d3.event.pageX) + "px")
                        .style("width", "150px") 
                        .style("top", (d3.event.pageY - 45) + "px");
            })                  
            .on("mouseout", function(d) {       
                tooltip.transition()        
                        .duration(500)
                        .style("opacity", 0);   
            })
            .on("click", loansClick);

        nodeEnter.append("svg:circle")
            .attr("r", 1e-6)
            .attr("y", "50");
  
        // text place
         var textspan = nodeEnter.append("svg:text")
                .attr("dy", ".25em")
                .attr("text-anchor", "middle");
         var tspan1 = textspan.append('tspan');
         var tspan2 = textspan.append('tspan');
         tspan1.text(function(d) { 
             var na = Util.getLimitedChar(d.name, 10);
//             if(d.count !='' && d.count !='n'){
//                 var na = na + '('+ d.count + ') ';
//             }
              return na ; })
               .attr("dy", function(d) { return (d.amount =='') ? "" : ".07em"; });
         tspan2.html(function(d) { var tex = d.currencySymbol +  d.amount; return tex ; })
                .attr("x", "0")
                .attr("dy", "15");
        // Transition nodes to their new position.
        var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        // node circle here
        nodeUpdate.select("circle")
            .attr("r",  function(d) {
                var rval = 30;
                switch(d.depth){
                    case 0:
                        rval = loansObj.lrootr;
                        break;
                    case 1:
                        rval = loansObj.llevel1r;
                        break;
                    case 2:
                    default:
                        rval = loansObj.llevel2r;
                                          
                }
                return rval;
            })
            .attr("class", function(d) {  return d.sel ? d.colorDefault : d.colorSelected; });

        nodeUpdate.select("text")
            .style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
            .remove();

        nodeExit.select("circle")
            .attr("r", 1e-6);

        nodeExit.select("text")
            .style("fill-opacity", 1e-6);

        // Update the links…
        var link = loansGroup.selectAll("path.link")
            .data(ltree.links(nodes), function(d) { return d.target.id; });

        // Enter any new links at the parent's previous position.
        link.enter().insert("svg:path", "g")
            .attr("class", "link")
            .attr("d", function(d) {
              var o = {x: source.x0, y: source.y0};
              return ldiagonal({source: o, target: o});
            })
          .transition()
            .duration(duration)
            .attr("d", ldiagonal);

        // Transition links to their new position.
        link.transition()
            .duration(duration)
            .attr("d", ldiagonal);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
            .duration(duration)
            .attr("d", function(d) {
              var o = {x: source.x, y: source.y};
              return ldiagonal({source: o, target: o});
            })
            .remove();

        // Stash the old positions for transition.
        nodes.forEach(function(d) {
          d.x0 = d.x;
          d.y0 = d.y;
        });
    }
    
    function loansClick(d) {
        if (d3.event.defaultPrevented) return; // click suppressed
        // change the color for selected one.
        if(d.depth!=0){
            d.sel = true;
            if(d.depth > 1 && d.parent){
                d.parent.sel = true
            }
        }        
        d = toggleChildren(d, true);
        loansUpdate(d);
        
        if(d.depth!==0){
            d.sel = false;           
            if(d.depth > 1 && d.parent){
                d.parent.sel = false;
            }
        }
        
        // update the property based on the loans
        if(propertiesObj){
            if(typeof d.id == 'undefined'){
                return false;
            }
            
            var loadid = 0;
            if(d.id > 0){
                loadid = d.id - 1;
            }
            
           // getPropertyAndRender(loadid);
            getPropertyAndRender('propertyloan', loadid, false, false);
        }
        
    } 

    // loans end
    /**********************************************
     * Properties D3 js
     **********************************************/
    
    function updatePtreeAngle(){
        propertiesObj.ptreeAngle = 360;
        if(propertiesObj.proot.children && propertiesObj.proot.children.length >= 1){
            if(propertiesObj.proot.children.length == 1){
                propertiesObj.ptreeAngle = -150;
               // propertiesObj.pnodedepth = 100;
            }else if(propertiesObj.proot.children.length == 2){
                propertiesObj.ptreeAngle = -180;
            }else if(propertiesObj.proot.children.length == 3){
                propertiesObj.ptreeAngle = -180;
            }else if(propertiesObj.proot.children.length >= 4){
                propertiesObj.ptreeAngle = 360;
            } 
        }

    }

    function renderProperties(){
        if(propertiesData && propertiesData!=''){
            propertiesObj.data = propertiesData;
            propertiesObj.proot = propertiesObj.data;
            propertiesObj.proot.x0 = propertiesObj.proot / 2;
            propertiesObj.proot.y0 = 0;
            // display only first level
            if(propertiesObj.proot.children && propertiesObj.proot.children.length >= 1){
                propertiesObj.proot.children.forEach(collapse);
                propertiesObj.proot.children[0].sel = true;
            }

            updatePtreeAngle();
            propertiesUpdate(propertiesObj.proot); 

            // after the svg update, reset it 
            if(propertiesObj.proot.children && propertiesObj.proot.children.length >= 1){
                propertiesObj.proot.children[0].sel = false;
            }            
        }
    }
    
    function propertiesUpdate(source) {
        
      var ptree = d3.layout.tree()
        .size([propertiesObj.ptreeAngle, propertiesObj.pheight])
        .separation(function(a, b) { return (a.parent == b.parent ? 5 : 10) / a.depth; });

        // Compute the new tree layout.
        var nodes = ptree.nodes(propertiesObj.proot),
            links = ptree.links(nodes);
        // Normalize for fixed-depth.
        nodes.forEach(function(d) { d.y = d.depth * propertiesObj.pnodedepth;
            if(isNaN(d.x)){
                d.x = d.depth * 270;
            }
        });

        // Update the nodes…
        var node = propertiesGroup.selectAll("g.node")
            .data(nodes, function(d) { return d.id || (d.id = ++propertiesObj.pi); });
        
        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { 
                return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")";
            })
            .on("mouseover", function(d) {
                tooltip.transition()        
                        .duration(200)
                        .style("opacity", .9);      
                tooltip.html(d.name + "<br/>"  + " ")
                        .style("left", (d3.event.pageX) + "px")     
                        .style("top", (d3.event.pageY - 28) + "px");
            })                  
            .on("mouseout", function(d) {       
                tooltip.transition()        
                        .duration(500)
                        .style("opacity", 0);   
            })
            .on("click", propertiesClick);
 

        nodeEnter.append("circle")
            .attr("r", 1e-6);
    
        nodeEnter.append("text")
            .attr("x", 10)
            .attr("dy", ".35em")
            .attr("text-anchor", "middle")
            .attr("transform", function(d) { return d.x < 180 ? "translate(0)" : "translate(-" + (d.name.length * 8.5)  + ")"; })
            .text(function(d) {
                var nap = Util.getLimitedChar(d.name, 10); 
               // if(d.count!='' && d.count!='n'){nap = nap + '(' + d.count+')'};
                return nap; })
            .style("fill-opacity", 1e-6);
       
       // Transition nodes to their new position.
       var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function(d) { 
                return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; 
               // return ""; 
            })

        nodeUpdate.selectAll("circle")
            .attr("r", function(d) {
                var rval = 30;
                switch(d.depth){
                    case 0:
                        rval = propertiesObj.prootr;
                        break;
                    case 1:
                        rval = propertiesObj.plevel1r;
                        break;
                    case 2:
                    default:
                        rval = propertiesObj.plevel2r;
                                          
                }
                return rval;
            })
            .attr("class", function(d) { return d.sel ? d.colorSelected : d.colorDefault; });
    
        nodeUpdate.selectAll("text")
            .style("fill-opacity", 1)
            .attr("transform", function(d) { 
                return  "rotate("+ ( -d.x + 90 )+ ")translate(-" + 10  + ")"; 
               // return  "translate(-" + 10  + ")"; 
            });
            
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
            .remove();

        nodeExit.select("circle")
            .attr("r", 1e-6);

        nodeExit.select("text")
            .style("fill-opacity", 1e-6);
    
        // Update the links…
        var link = propertiesGroup.selectAll("path.link")
            .data(ptree.links(nodes), function(d) { return d.target.id; });        

        // Enter any new links at the parent's previous position.
        link.enter().insert("svg:path", "g")
            .attr("class", "link")
            .attr("d", function(d) {
                if(typeof source.x0 === "undefined" ){
                    source.x0 = 400;
                }
                if(typeof source.y0 === "undefined" ){
                    source.y0 = 0;
                }                
              var o = {x: source.x0, y: source.y0};
              return ldiagonal({source: o, target: o});
            })
          .transition()
            .duration(duration)
            .attr("d", ldiagonal);
        // Transition links to their new position.
        link.transition()
            .duration(duration)
            .attr("d", pdiagonal);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
            .duration(duration)
            .attr("d", function(d) {
              var o = {x: source.x, y: source.y};
              return pdiagonal({source: o, target: o});
            })
            .remove();

        // Stash the old positions for transition.
        nodes.forEach(function(d) {
          d.x0 = d.x;
          d.y0 = d.y;
        });
    }

    function propertiesClick(d) {
        if (d3.event.defaultPrevented) return; // click suppressed
        
        if(d.depth!=0){
            d.sel = true;
            if(d.depth > 1 && d.parent){
                d.parent.sel = true
            }
        }
        
        d = toggleChildren(d, false);
        propertiesUpdate(d);

        if(d.depth!=0){
            d.sel = false;           
            if(d.depth > 1 && d.parent){
                d.parent.sel = false;
            }
        } 
    }
    
function zoomed() {
  container.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}

$(window).resize(function(){
   // location.reload();

});
 // document ready end  

});
 
</script>
</body>
</html>