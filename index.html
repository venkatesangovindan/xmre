<!DOCTYPE html>
<html>
<head>
    <title>XMRE - Deals, Loans, Properties</title>
    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/util.js"></script>
    <link rel="stylesheet" href="css/style.css" type="text/css">
    <style>
.axis line {
  fill: none;
  stroke: #ddd;
  shape-rendering: crispEdges;
  vector-effect: non-scaling-stroke;
}        

    </style>
</head>
<body>
    <div id="container">
        <div id="social_graph"></div>
    </div>

<script>
$( document ).ready(function() {
        
    /*********************************
     * Common functions and variables - Helper functions for collapsing and expanding nodes.
     *********************************/

    function collapse(d) {
        if (d.children) {
            d._children = d.children;
            d._children.forEach(collapse);
            d.children = null;
        }
    }

    function expand(d) {
        if (d._children) {
            d.children = d._children;
            d.children.forEach(expand);
            d._children = null;
        }
    }   
    // Toggle children function
    function toggleChildren(d, rootToggle) {
        
        // rootToggle is false always show root node with one level
        if(!rootToggle && !d.parent){
            return d;            
        }        
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else if (d._children) {
            d.children = d._children;
            d._children = null;
        }
        return d;
    }
    
    var windowwidth = $( window ).width(); // window width
    var sgraphHeight = 450;    
    
    var margin = {top: 5, right: 0, bottom: 5, left: 0},
        width = windowwidth - margin.left - margin.right - 15,
        height = sgraphHeight - margin.top - margin.bottom;
        
    var duration = 500;
    
    var zoom = d3.behavior.zoom()
        .scaleExtent([1, 10])
        .on("zoom", zoomed);

    var svg = d3.select("#social_graph").append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .append("g")
        .attr("viewBox", "0 0 " + width + " " + height )
        .attr("overflow", "hidden")
        .attr("transform", "translate(" + margin.left + "," + margin.right + ")")
        .call(zoom);

    var rect = svg.append("rect")
        .attr("width", width)
        .attr("height", height)
        .style("fill", "none")
        .style("pointer-events", "all");

    var container = svg.append("g");

    var tooltip = d3.select("body").append("div")   
        .attr("class", "tooltip")               
        .style("opacity", 0);
   
    /********************************************
     * All the graph methods and configs
     ********************************************/
    // deals
    function deals(){}    
    // initial configs
    // deals graph start position
    deals.prototype.dealsStart = windowwidth / 100 * 80 ; // start after 80 % 
    deals.prototype.drootr = 40;
    deals.prototype.dlevel1r = 30;
    deals.prototype.dnodedepth = 100;
    
    deals.prototype.di = 0;    
    deals.prototype.maxDisplayChar = 10;
    deals.prototype.droot = '';
    
    deals.prototype.dviewerWidth = 800;
    deals.prototype.dviewerHeight = 450;

    var dealsObj = new deals();
    
    // for responsive
    if(dealsObj.dealsStart < 1000){
        dealsObj.drootr = 30;
        dealsObj.dlevel1r = 25;
        dealsObj.dnodedepth = 80;
    }

    // loans
    function loans(){}
    // loans graph start position
    loans.prototype.loansStart = windowwidth / 100 * 55 ; // start after 40 %
    loans.prototype.lrootr = 40;
    loans.prototype.llevel1r = 35;
    loans.prototype.llevel2r = 30;
    loans.prototype.lnodedepth = 100;
    loans.prototype.lnodesizex = 80;
    loans.prototype.lnodesizey = 80;    
    
    loans.prototype.li = 0;    
    loans.prototype.maxDisplayChar = 10;
    loans.prototype.lroot = '';    
    loans.prototype.lheight = 430;      
  

    var loansObj = new loans();
        // for responsive
    if(loansObj.loansStart < 650){
        loansObj.lrootr = 30;
        loansObj.llevel1r = 25;
        loansObj.llevel2r = 20;        
        loansObj.lnodesizex = 60;
        loansObj.lnodesizey = 30;
        loansObj.lnodedepth = 80;
    }    
    
    // properties
    function properties(){};    
    // properties graph start position
    properties.prototype.propertiesStart = windowwidth / 100 * 20 ; // start after 20 %
    properties.prototype.prootr = 40;
    properties.prototype.plevel1r = 35;
    properties.prototype.plevel2r = 25;
    properties.prototype.pnodedepth = 90;
    properties.prototype.pheight = 800; 
    
    properties.prototype.pi = 0;    
    properties.prototype.maxDisplayChar = 10;
    properties.prototype.proot = '';

    var propertiesObj = new properties();
        // for responsive
    if(propertiesObj.propertiesStart < 200){
        propertiesObj.prootr = 30;
        propertiesObj.plevel1r = 25;
        propertiesObj.plevel2r = 20;
        propertiesObj.pnodedepth = 70;
    }    
    // Draw straight lines between loans and properties    
    var loansToPropertiesLine = container.append("g:line")
        .attr("x1", propertiesObj.propertiesStart + propertiesObj.prootr)
        .attr("y1", 205)
        .attr("x2", loansObj.loansStart - loansObj.lrootr)
        .attr("y2", 205)
        .attr("class", "loansToProperties"); 
    // Draw straight lines between deals and loans
    var dealsToLoansLine = container.append("g:line")
        .attr("x1", loansObj.loansStart + loansObj.lrootr)
        .attr("y1", 205)
        .attr("x2", dealsObj.dealsStart - dealsObj.drootr)
        .attr("y2", 205)
        .attr("class", "dealsToLoans");
    
    
//container.append("g")
//    .attr("class", "x axis")
//  .selectAll("line")
//    .data(d3.range(0, width, 10))
//  .enter().append("line")
//    .attr("x1", function(d) { return d; })
//    .attr("y1", 0)
//    .attr("x2", function(d) { return d; })
//    .attr("y2", height);
//
//container.append("g")
//    .attr("class", "y axis")
//  .selectAll("line")
//    .data(d3.range(0, height, 10))
//  .enter().append("line")
//    .attr("x1", 0)
//    .attr("y1", function(d) { return d; })
//    .attr("x2", width)
//    .attr("y2", function(d) { return d; });

    /**********************************************
     * Deals D3 js
     **********************************************/                 
   

    deals.data = {
        name : "EURO 25X",
        currencySymbol: "&pound;",
        amount: "80.1M",
        colorDefault: "dealsDefault",
        colorSelected: "dealsSelected",
        sel: true,        
        children : [
            {
                name : "A",
                currencySymbol: "&pound;",
                amount: "80.1M",
                colorDefault: "tranchesDefault",
                colorSelected: "tranchesSelected",
                sel: false                 
            },
            {
                name : "B",
                currencySymbol: "&pound;",
                amount: "80.1M", 
                colorDefault: "tranchesDefault",
                colorSelected: "tranchesSelected",
                sel: false                 
            },
            {
                name : "C",
                currencySymbol: "&pound;",
                amount: "80.1M",
                colorDefault: "tranchesDefault",
                colorSelected: "tranchesSelected",
                sel: false                 
            },
            {
                name : "D",
                currencySymbol: "&pound;",
                amount: "80.1M",
                colorDefault: "tranchesDefault",
                colorSelected: "tranchesSelected",
                sel: false                 
            },
            {
                name : "E",
                currencySymbol: "&pound;",
                amount: "80.1M",
                colorDefault: "tranchesDefault",
                colorSelected: "tranchesSelected",
                sel: false,
            }
    ]};
             

    var dtree = d3.layout.tree()
       .size([dealsObj.dviewerHeight, dealsObj.dviewerWidth]);

    // define a d3 diagonal projection for use by the node paths later on.
    var ddiagonal = d3.svg.diagonal()
        .projection(function(d) {
            return [d.y, d.x];
        });

    var dealsGroup = container.append("g")
                               .attr("transform", "translate("+ dealsObj.dealsStart + ",-20)");  

    function dealsClick(d) {
        if (d3.event.defaultPrevented) return; // click suppressed
        
        if(d.depth!=0){
            d.sel = true;
            if(d.depth > 1 && d.parent){
                d.parent.sel = true
            }
        }
        
        d = toggleChildren(d, true);
        dealsUpdate(d);
        
        if(d.depth!=0){
            d.sel = false;           
            if(d.depth > 1 && d.parent){
                d.parent.sel = false;
            }
        }        
    }

    function dealsUpdate(source) {
        dtree = dtree.size([dealsObj.dviewerHeight, dealsObj.dviewerWidth]);
        // Compute the new tree layout.
        var nodes = dtree.nodes(dealsObj.droot).reverse(),
            links = dtree.links(nodes);

        // Set widths between levels based on node depth
        nodes.forEach(function(d) {
            d.y = (d.depth * dealsObj.dnodedepth); 
        });

        // Update the nodesâ€¦
        var node = dealsGroup.selectAll("g.node")
            .data(nodes, function(d) {
                return d.id || (d.id = ++dealsObj.di);
            });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) {
                return "translate(" + source.y0 + "," + source.x0 + ")";
            })
            .on("mouseover", function(d) {
                tooltip.transition()        
                        .duration(200)
                        .style("opacity", .9);      
                tooltip.html(d.name + "<br/>" + "  ")
                        .style("left", (d3.event.pageX) + "px")
                        .style("width", "150px") 
                        .style("top", (d3.event.pageY - 45) + "px");
            })                  
            .on("mouseout", function(d) {       
                tooltip.transition()        
                        .duration(500)
                        .style("opacity", 0);   
            })            
            .on('click', dealsClick);

        nodeEnter.append("circle")
            .attr('class', 'nodeCircle')
            .attr("r", 0);

        var textspan = nodeEnter.append("text")
                .attr("dy", ".20em")
                .attr("text-anchor", "middle");
        
         var tspan1 = textspan.append('tspan');
         var tspan2 = textspan.append('tspan');
         
         tspan1.text(function(d) { return Util.wordWrap(d.name, dealsObj.maxDisplayChar); })
               .attr("dy", function(d) { return (d.amount ==='') ? "" : ".07em"; });
         tspan2.html(function(d) { 
                    if(d.amount){var tex = d.currencySymbol +  d.amount; return tex ;}
                        return '';
                    })
                .attr("x", "0")
                .style("color", "blueviolet")
                .attr("dy", "15");

        // Update the text to reflect whether node has children or not.
        node.select('text')
            .attr("x", function(d) {
                return d.children || d._children ? 0 : 0;
            })
            .attr("text-anchor", function(d) {
                return d.children || d._children ? "middle" : "middle";
            })

        // Change the circle fill depending on whether it has children and is collapsed
        node.select("circle")
            .attr("r",   function(d) {
                var rval = 30;
                switch(d.depth){
                    case 0:
                        rval = dealsObj.drootr;
                        break;
                    default:                        
                        rval = dealsObj.dlevel1r;
                }
                return rval;
            })
            .attr("class", function(d) {//console.log(d);  
                            return d.sel ? d.colorSelected : d.colorDefault; 
            });

        // Transition nodes to their new position.
        var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function(d) {
                return "translate(" + d.y + "," + d.x + ")";
            });

        // Fade the text in
        nodeUpdate.select("text")
            .style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function(d) {
                return "translate(" + source.y + "," + source.x + ")";
            })
            .remove();

        nodeExit.select("circle")
            .attr("r", 0);

        nodeExit.select("text")
            .style("fill-opacity", 0);

        // Update the linksâ€¦
        var link = dealsGroup.selectAll("path.link")
            .data(links, function(d) {
                return d.target.id;
            });

        // Enter any new links at the parent's previous position.
        link.enter().insert("path", "g")
            .attr("class", "link")
            .attr("d", function(d) {
                var o = {
                    x: source.x0,
                    y: source.y0
                };
                return ddiagonal({
                    source: o,
                    target: o
                });
            });

        // Transition links to their new position.
        link.transition()
            .duration(duration)
            .attr("d", ddiagonal);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
            .duration(duration)
            .attr("d", function(d) {
                var o = {
                    x: source.x,
                    y: source.y
                };
                return ddiagonal({
                    source: o,
                    target: o
                });
            })
            .remove();

        // Stash the old positions for transition.
        nodes.forEach(function(d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    // Define the root
    dealsObj.droot = deals.data;
    dealsObj.droot.x0 = dealsObj.dviewerHeight / 2;
    dealsObj.droot.y0 = 0;
    
    // only show first level nodes
    dealsObj.droot.children.forEach(collapse);
    dealsUpdate(dealsObj.droot);

    // deals over
    /**********************************************
     * Loans D3 js
     **********************************************/
    loans.data = {
        name : "Loans",
        count: 6,
        currencySymbol: "",
        amount: "",
        colorDefault: "loansDefault",
        colorSelected: "loansSelected",
        sel: true,
        children : [
            {
                name : "Antony Parc Office",
                count: "n",
                currencySymbol: "&pound;",
                amount: "80.1M",
                colorDefault: "b-loansDefault",
                colorSelected: "b-loansSelected",
                sel: false,
                children : [
                    {
                        name : "B",
                        count: "n",
                        currencySymbol: "&pound;",
                        amount: "80.1M",
                        colorDefault: "sun-juniorDefault",
                        colorSelected: "sun-juniorSelected",                         
                        sel: false
                    }]
            },
            {
                name : "Aprirose Retail Portfolio",
                count: "n",
                currencySymbol: "&pound;",
                amount: "28.9M",
                colorDefault: "b-loansDefault",
                colorSelected: "b-loansSelected",
                sel: false
            },
            {
                name : "Eurocastle Portfolio",
                count: "n",
                currencySymbol: "&pound;",
                amount: "199.6M",
                colorDefault: "b-loansDefault",
                colorSelected: "b-loansSelected",
                sel: false,
                children : [
                    {
                        name : "B",
                        count: "n",
                        currencySymbol: "&pound;",
                        amount: "2.6M",
                        colorDefault: "sun-juniorDefault",
                        colorSelected: "sun-juniorSelected",
                        sel: false
                    }]            
            },
            {
                name : "Metropolis Centre",
                count: "n",
                currencySymbol: "&pound;",
                amount: "59.3M",
                colorDefault: "b-loansDefault",
                colorSelected: "b-loansSelected",
                sel: false,                
            },
            {
                name : "Nextra Portfolio Italy",
                count: "n",
                currencySymbol: "&pound;",
                amount: "81.1M",
                colorDefault: "b-loansDefault",
                colorSelected: "b-loansSelected",
                sel: false
            },
            {
                name : "Orazio Portfolio",
                count: "n",
                currencySymbol: "&pound;",
                amount: "100M",
                colorDefault: "b-loansDefault",
                colorSelected: "b-loansSelected",
                sel: false,
                children : [
                    {
                        name : "B",
                        count: "n",
                        currencySymbol: "&pound;",
                        amount: "206.3M",
                        colorDefault: "sun-juniorDefault",
                        colorSelected: "sun-juniorSelected", 
                        sel: false,
                        children : [
                            {
                                name : "C",
                                count: "n",
                                currencySymbol: "&pound;",
                                amount: "2144.1M",
                                colorDefault: "sun-juniorDefault",
                                colorSelected: "sun-juniorSelected",                                  
                                sel: false
                            }] 
                    }]
            }
    ]};

    var ltree = d3.layout.tree()
        .nodeSize([loansObj.lnodesizex, loansObj.lnodesizey]);

    var ldiagonal = d3.svg.diagonal()
            .projection(function(d) { return [d.x, d.y]; });
    
    var loansGroup = container.append("g")
                               .attr("transform", "translate("+ loansObj.loansStart +",205)");     
    
    loansObj.lroot = loans.data;
    loansObj.lroot.x0 = loansObj.lheight / 2;
    loansObj.lroot.y0 = 0;
    // display only first level
    loansObj.lroot.children.forEach(collapse);    
    loansUpdate(loansObj.lroot); 
    
    function loansUpdate(source) {
        // Compute the new tree layout.
        var nodes = ltree.nodes(loansObj.lroot).reverse();
        var links = ltree.links(nodes);

        // Normalize for fixed-depth. - parent to child
        nodes.forEach(function(d) { d.y = d.depth * loansObj.lnodedepth; });

        // Update the nodesâ€¦
        var node = loansGroup.selectAll("g.node")
            .data(nodes, function(d) { return d.id || (d.id = ++loansObj.li); });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("svg:g")
            .attr("class", "node")
            .attr("transform", function(d) { return "translate(" + d.x + "," + (d.y + 10) + ")"; })
            .on("mouseover", function(d) {
                tooltip.transition()        
                        .duration(200)
                        .style("opacity", .9);      
                tooltip.html(d.name + "<br/>"  + ( (d.amount)? (' ( '+ d.currencySymbol +  d.amount +' )') :"") )
                        .style("left", (d3.event.pageX) + "px")
                        .style("width", "150px") 
                        .style("top", (d3.event.pageY - 45) + "px");
            })                  
            .on("mouseout", function(d) {       
                tooltip.transition()        
                        .duration(500)
                        .style("opacity", 0);   
            })
            .on("click", loansClick);

        nodeEnter.append("svg:circle")
            .attr("r", 1e-6)
            .attr("y", "50");
  
        // text place
         var textspan = nodeEnter.append("svg:text")
                .attr("dy", ".25em")
                .attr("text-anchor", "middle");
         var tspan1 = textspan.append('tspan');
         var tspan2 = textspan.append('tspan');
         tspan1.text(function(d) { 
             var na = Util.getLimitedChar(d.name, 10);
             if(d.count !='' && d.count !='n'){
                 var na = na + '('+ d.count + ') ';
             }
              return na ; })
               .attr("dy", function(d) { return (d.amount =='') ? "" : ".07em"; });
         tspan2.html(function(d) { var tex = d.currencySymbol +  d.amount; return tex ; })
                .attr("x", "0")
                .attr("dy", "15");
        // Transition nodes to their new position.
        var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        // node circle here
        nodeUpdate.select("circle")
            .attr("r",  function(d) {
                var rval = 30;
                switch(d.depth){
                    case 0:
                        rval = loansObj.lrootr;
                        break;
                    case 1:
                        rval = loansObj.llevel1r;
                        break;
                    case 2:
                    default:
                        rval = loansObj.llevel2r;
                                          
                }
                return rval;
            })
            .attr("class", function(d) {//console.log(d);  
        return d.sel ? d.colorDefault : d.colorSelected; });
            //.style("fill", function(d) {console.log(d); return d._children ? "lightsteelblue" : d.colorFill; });

        nodeUpdate.select("text")
            .style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
            .remove();

        nodeExit.select("circle")
            .attr("r", 1e-6);

        nodeExit.select("text")
            .style("fill-opacity", 1e-6);

        // Update the linksâ€¦
        var link = loansGroup.selectAll("path.link")
            .data(ltree.links(nodes), function(d) { return d.target.id; });

        // Enter any new links at the parent's previous position.
        link.enter().insert("svg:path", "g")
            .attr("class", "link")
            .attr("d", function(d) {
              var o = {x: source.x0, y: source.y0};
              return ldiagonal({source: o, target: o});
            })
          .transition()
            .duration(duration)
            .attr("d", ldiagonal);

        // Transition links to their new position.
        link.transition()
            .duration(duration)
            .attr("d", ldiagonal);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
            .duration(duration)
            .attr("d", function(d) {
              var o = {x: source.x, y: source.y};
              return ldiagonal({source: o, target: o});
            })
            .remove();

        // Stash the old positions for transition.
        nodes.forEach(function(d) {
          d.x0 = d.x;
          d.y0 = d.y;
        });
    }
    
    function loansClick(d) {
        if (d3.event.defaultPrevented) return; // click suppressed
        // change the color for selected one.
        if(d.depth!=0){
            d.sel = true;
            if(d.depth > 1 && d.parent){
                d.parent.sel = true
            }
        }        
        d = toggleChildren(d, true);
        loansUpdate(d);
        
        if(d.depth!==0){
            d.sel = false;           
            if(d.depth > 1 && d.parent){
                d.parent.sel = false;
            }
        }
    } 
    // loans end
    /**********************************************
     * Properties D3 js
     **********************************************/
properties.data = {
    
        name : "Properties",
        count: 6,
        colorDefault: "propertiesDefault",
        colorSelected: "propertiesSelected",
        sel: true,
        plusSign: false,
        children : [
            {
                name : "Bayreuth, 6",
                count: "n",           
                plusSign: true,
                colorDefault: "properties-singleDefault",
                colorSelected: "properties-singleSelected",
                sel: false,                
                children : [
                    {
                        name : "Sponsor",
                        count: "",
                        colorDefault: "sponsorDefault",
                        colorSelected: "sponsorSelected",
                        sel: false,
                        plusSign: false
                    },{
                        name : "Tenant",
                        count: "",
                        colorDefault: "tenantDefault",
                        colorSelected: "tenantSelected",
                        sel: false, 
                        plusSign: false
                    }]
            },{
                name : "Lichtenfels, Mainau 16",
                count: "n",           
                plusSign: true,
                colorDefault: "properties-singleDefault",
                colorSelected: "properties-singleSelected",
                sel: false,                  
                children : [
                    {
                        name : "Sponsor",
                        count: "",
                        colorDefault: "sponsorDefault",
                        colorSelected: "sponsorSelected",
                        sel: false,                        
                        plusSign: false
                    },{
                        name : "Tenant",
                        count: "",
                        colorDefault: "tenantDefault",
                        colorSelected: "tenantSelected",
                        sel: false, 
                        plusSign: false
                    }]
            },
            {
                name : "Munchberg",
                count: "n",           
                plusSign: true,
                colorDefault: "properties-singleDefault",
                colorSelected: "properties-singleSelected",
                sel: false,                  
                children : [
                    {
                        name : "Sponsor",
                        count: "",
                        colorDefault: "sponsorDefault",
                        colorSelected: "sponsorSelected",
                        sel: false,                        
                        plusSign: false
                    },{
                        name : "Tenant",
                        count: "",
                        colorDefault: "tenantDefault",
                        colorSelected: "tenantSelected",
                        sel: false,                         
                        plusSign: false
                    }]
            },
            {
                name : "Munnerstadt",
                count: "n",           
                plusSign: true,
                colorDefault: "properties-singleDefault",
                colorSelected: "properties-singleSelected",
                sel: false,                 
                children : [
                    {
                        name : "Sponsor",
                        count: "",
                        colorDefault: "sponsorDefault",
                        colorSelected: "sponsorSelected",
                        sel: false,                        
                        plusSign: false
                    },{
                        name : "Tenant",
                        count: "",
                        colorDefault: "tenantDefault",
                        colorSelected: "tenantSelected",
                        sel: false,                         
                        plusSign: false
                    }]
            },
            {
                name : "Beckum",
                count: "n",           
                plusSign: true,
                colorDefault: "properties-singleDefault",
                colorSelected: "properties-singleSelected",
                sel: false,                
                children : [
                    {
                        name : "Sponsor",
                        count: "",
                        colorDefault: "sponsorDefault",
                        colorSelected: "sponsorSelected",
                        sel: false,                        
                        plusSign: false
                    },{
                        name : "Tenant",
                        count: "",
                        colorDefault: "tenantDefault",
                        colorSelected: "tenantSelected",
                        sel: false,                        
                        plusSign: false
                    }]
            }
    ]};
    console.log( properties.data.children.length);
    // get the angles for properties tree
    var ptreeAngle = 360;
    
    if(properties.data.children.length == 1){
        ptreeAngle = 90;
    }else if(properties.data.children.length == 2){
        ptreeAngle = -180;
    }else if(properties.data.children.length == 3){
        ptreeAngle = -180;
        propertiesObj.pnodedepth = 100;
    }else if(properties.data.children.length == 4){
        ptreeAngle = 360;
    }
    var ptree = d3.layout.tree()
        .size([ptreeAngle, propertiesObj.pheight])
        .separation(function(a, b) { return (a.parent == b.parent ? 5 : 10) / a.depth; });

    var pdiagonal = d3.svg.diagonal.radial()
        .projection(function(d) { return [d.y, d.x / 180 * Math.PI]; }); 

    var propertiesGroup = container.append("g")
        .attr("transform", "translate("+ propertiesObj.propertiesStart +",205)");

   // Define the root
    propertiesObj.proot = properties.data;
    propertiesObj.proot.x0 = propertiesObj.pheight / 2;
    propertiesObj.proot.y0 = 0;
    
    // only show first level nodes
    propertiesObj.proot.children.forEach(collapse);    
    propertiesUpdate(propertiesObj.proot);
    
    function propertiesUpdate(source) {       
        // Compute the new tree layout.
        var nodes = ptree.nodes(propertiesObj.proot),
            links = ptree.links(nodes);
        // Normalize for fixed-depth.
        nodes.forEach(function(d) { d.y = d.depth * propertiesObj.pnodedepth; });

        // Update the nodesâ€¦
        var node = propertiesGroup.selectAll("g.node")
            .data(nodes, function(d) { return d.id || (d.id = ++propertiesObj.pi); });
        
        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
            .on("mouseover", function(d) {
                tooltip.transition()        
                        .duration(200)
                        .style("opacity", .9);      
                tooltip.html(d.name + "<br/>"  + " ")
                        .style("left", (d3.event.pageX) + "px")     
                        .style("top", (d3.event.pageY - 28) + "px");
            })                  
            .on("mouseout", function(d) {       
                tooltip.transition()        
                        .duration(500)
                        .style("opacity", 0);   
            })
            .on("click", propertiesClick);
 

        nodeEnter.append("circle")
            .attr("r", 1e-6);
    
        nodeEnter.append("text")
            .attr("x", 10)
            .attr("dy", ".35em")
            .attr("text-anchor", "middle")
            .attr("transform", function(d) { return d.x < 180 ? "translate(0)" : "translate(-" + (d.name.length * 8.5)  + ")"; })
            .text(function(d) { 
                var nap = Util.getLimitedChar(d.name, 10); 
                if(d.count!='' && d.count!='n'){nap = nap + '(' + d.count+')'};
                return nap; })
            .style("fill-opacity", 1e-6);
       
       // Transition nodes to their new position.
       var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })

        nodeUpdate.select("circle")
            .attr("r", function(d) {
                var rval = 30;
                switch(d.depth){
                    case 0:
                        rval = propertiesObj.prootr;
                        break;
                    case 1:
                        rval = propertiesObj.plevel1r;
                        break;
                    case 2:
                    default:
                        rval = propertiesObj.plevel2r;
                                          
                }
                return rval;
            })
            .attr("class", function(d) {//console.log(d);  
                            return d.sel ? d.colorSelected : d.colorDefault; 
            });
    
        nodeUpdate.select("text")
            .style("fill-opacity", 1)
            .attr("transform", function(d) { return  "rotate("+ ( -d.x + 90 )+ ")translate(-" + 10  + ")"; });
            
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
            .remove();

        nodeExit.select("circle")
            .attr("r", 1e-6);

        nodeExit.select("text")
            .style("fill-opacity", 1e-6);

        // Update the linksâ€¦
        var link = propertiesGroup.selectAll("path.link")
            .data(links, function(d) { return d.target.id; });

        // Enter any new links at the parent's previous position.
        link.enter().insert("path", "g")
            .attr("class", "link")
            .attr("d", function(d) {
              var o = {x: source.x0, y: source.y0};
              return pdiagonal({source: o, target: o});
            });

        // Transition links to their new position.
        link.transition()
            .duration(duration)
            .attr("d", pdiagonal);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
            .duration(duration)
            .attr("d", function(d) {
              var o = {x: source.x, y: source.y};
              return pdiagonal({source: o, target: o});
            })
            .remove();

        // Stash the old positions for transition.
        nodes.forEach(function(d) {
          d.x0 = d.x;
          d.y0 = d.y;
        });
    }

    function propertiesClick(d) {
        if (d3.event.defaultPrevented) return; // click suppressed
        
        if(d.depth!=0){
            d.sel = true;
            if(d.depth > 1 && d.parent){
                d.parent.sel = true
            }
        }
        
        d = toggleChildren(d, false);
        propertiesUpdate(d);

        if(d.depth!=0){
            d.sel = false;           
            if(d.depth > 1 && d.parent){
                d.parent.sel = false;
            }
        } 
    }    
    
function zoomed() {
  container.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}

$(window).resize(function(){
    location.reload();

});
 // document ready end   
});


</script>
</body>
</html>